<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Flashcards – Allmänt (Mobilvänlig)</title>
<meta name="theme-color" content="#0f172a" />
<style>
  :root{
    --bg:#0f172a; --panel:#0c1224; --muted:#9aa5b1; --text:#ecf0f1;
    --primary:#22d3ee; --accent:#a78bfa; --good:#34d399; --bad:#f87171;
    --border: rgba(255,255,255,.12);
    --radius: 14px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    background: var(--bg); color:var(--text);
    -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
  }
  .wrap{max-width:780px; margin:0 auto; padding:16px; padding-bottom:80px}
  header{display:flex; align-items:center; gap:12px; justify-content:space-between}
  .brand{display:flex; align-items:center; gap:10px}
  .logo{width:36px; height:36px; border-radius:10px; background:linear-gradient(135deg, var(--primary), var(--accent))}
  h1{margin:0; font-size:20px}
  .info{font-size:12px; color:var(--muted)}
  .panel{margin-top:12px; background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); padding:12px}
  .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  select, button, input[type="url"], input[type="text"], input[type="file"]{
    flex:0 0 auto; font-size:16px; border-radius:12px; padding:10px 12px;
    background:#0b1224; color:var(--text); border:1px solid var(--border);
    touch-action:manipulation;
  }
  input[type="url"], input[type="text"], input[type="file"]{ width: min(380px, 100%); }
  button:active{transform:scale(.98)}
  .btn-pri{border-color: rgba(34,211,238,.45)}
  .btn-good{border-color: rgba(52,211,153,.45)}
  .btn-bad{border-color: rgba(248,113,113,.45)}
  .card{
    margin-top:14px; min-height:180px; display:flex; align-items:center; justify-content:center;
    background:#0b1224; border:1px solid var(--border); border-radius: calc(var(--radius) + 4px);
    padding:18px; text-align:center;
  }
  .q{font-size:18px; line-height:1.35}
  .a{font-size:18px; color:#d1fae5}
  .hint{font-size:12px; color:var(--muted); margin-top:6px; text-align:center}
  .actions{position:sticky; bottom:0; left:0; right:0; background:linear-gradient(0deg, rgba(15,23,42,.95), rgba(15,23,42,.85));
    padding:10px 12px; border-top:1px solid var(--border); display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px}
  .btn-big{padding:14px 10px; font-weight:600}
  .progress{margin-top:10px}
  .bar{height:10px; background:#0a1020; border:1px solid var(--border); border-radius:999px; overflow:hidden}
  .bar>span{display:block; height:100%; background:linear-gradient(90deg, var(--primary), var(--accent)); width:0%}
  .footer{margin-top:6px; font-size:12px; color:var(--muted); text-align:center}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Flashcards</h1>
          <div class="info" id="stats-line">0 kort</div>
        </div>
      </div>
      <button id="btn-help" aria-label="Hjälp">❓</button>
    </header>

    <section class="panel">
      <div class="row">
        <select id="category" aria-label="Välj kategori">
          <option value="ALLA">Alla kategorier</option>
        </select>
        <button id="btn-shuffle" class="btn-pri">Blanda</button>
        <button id="btn-reset">Återställ</button>
      </div>
      <div class="row">
        <input id="file-input" type="file" multiple accept=".json,.csv,.tsv" aria-label="Ladda filer (JSON/CSV)">
        <input id="url-input" type="url" placeholder="https://exempel.se/kort.json eller .csv" aria-label="Klistra in URL till JSON/CSV">
        <button id="btn-load-url" class="btn-pri">Ladda URL</button>
        <button id="btn-load-sample">Exempelkort</button>
        <button id="btn-clear">Töm kort</button>
      </div>
      <div class="info">Format: JSON [{id?, cat?, q, a}] eller CSV med rubrikerna id,cat,q,a</div>
    </section>

    <section>
      <div class="card" id="card" role="button" aria-pressed="false" aria-roledescription="flashcard">
        <div id="card-content" class="q">Laddar …</div>
      </div>
      <div class="hint" id="hint">Tryck på kortet för att vända</div>

      <div class="progress">
        <div class="bar"><span id="bar"></span></div>
      </div>
      <div class="footer" id="footer"></div>
    </section>
  </div>

  <nav class="actions" aria-label="Kontroller">
    <button id="btn-prev" class="btn-big">◀︎ Förra</button>
    <button id="btn-flip" class="btn-big btn-pri">Visa svar</button>
    <button id="btn-next" class="btn-big">Nästa ▶︎</button>
    <button id="btn-good" class="btn-big btn-good">Kunde</button>
    <button id="btn-bad" class="btn-big btn-bad">Inte kunde</button>
    <button id="btn-full" class="btn-big">Fullskärm</button>
  </nav>

<script>
/* --- Data / Innehållskällor --- */
const SAMPLE_CARDS = [
  {id:"sample-1", cat:"Exempel", q:"Vad är 2 + 2?", a:"4"},
  {id:"sample-2", cat:"Exempel", q:"Huvudstad i Sverige?", a:"Stockholm"},
  {id:"sample-3", cat:"Exempel", q:"Engelska för 'äpple'?", a:"apple"}
];
let allCards = [];

/* --- State --- */
let state = {
  deck: [],
  index: 0,
  showAnswer: false,
  streak: 0,
  filter: 'ALLA',
  stats: (function(){
    // Robust localStorage (safe fallback on mobile file:// and private modes)
    try {
      const raw = localStorage.getItem('geoFlashcardsProgressV2');
      return raw ? JSON.parse(raw) : {correct:{}, wrong:{}};
    } catch(e){
      return {correct:{}, wrong:{}, _memoryOnly:true};
    }
  })()
};
function persist(){
  try { localStorage.setItem('geoFlashcardsProgressV2', JSON.stringify(state.stats)); } catch(e){ /* memory-only */ }
}

/* --- Elements --- */
const els = {
  category: document.getElementById('category'),
  statsLine: document.getElementById('stats-line'),
  card: document.getElementById('card'),
  cardContent: document.getElementById('card-content'),
  hint: document.getElementById('hint'),
  bar: document.getElementById('bar'),
  footer: document.getElementById('footer'),
  btnPrev: document.getElementById('btn-prev'),
  btnNext: document.getElementById('btn-next'),
  btnFlip: document.getElementById('btn-flip'),
  btnGood: document.getElementById('btn-good'),
  btnBad: document.getElementById('btn-bad'),
  btnShuffle: document.getElementById('btn-shuffle'),
  btnReset: document.getElementById('btn-reset'),
  btnHelp: document.getElementById('btn-help'),
  btnFull: document.getElementById('btn-full'),
  fileInput: document.getElementById('file-input'),
  urlInput: document.getElementById('url-input'),
  btnLoadUrl: document.getElementById('btn-load-url'),
  btnLoadSample: document.getElementById('btn-load-sample'),
  btnClear: document.getElementById('btn-clear'),
};

/* --- Hjälpfunktioner för laddning/parsing --- */
function rebuildCategoryOptions(){
  const existing = new Set();
  els.category.innerHTML = '';
  const allOpt = document.createElement('option');
  allOpt.value = 'ALLA'; allOpt.textContent = 'Alla kategorier';
  els.category.appendChild(allOpt);
  Array.from(new Set(allCards.map(c => c.cat || 'Okategoriserad'))).forEach(cat => {
    if(existing.has(cat)) return; existing.add(cat);
    const opt = document.createElement('option');
    opt.value = cat; opt.textContent = cat; els.category.appendChild(opt);
  });
}

function simpleCsvParse(line){
  const cells = [];
  let cur = '', inQuotes = false;
  for(let i=0;i<line.length;i++){
    const ch = line[i];
    if(ch==='"'){
      if(inQuotes && line[i+1]==='"'){ cur+='"'; i++; }
      else { inQuotes = !inQuotes; }
    } else if(ch===',' && !inQuotes){ cells.push(cur); cur=''; }
    else { cur += ch; }
  }
  cells.push(cur);
  return cells.map(s=>s.trim());
}

function parseCSV(text){
  const lines = text.split(/\r?\n/).filter(l=>l.trim().length>0);
  if(lines.length===0) return [];
  const header = simpleCsvParse(lines[0]).map(h=>h.toLowerCase());
  const idx = {
    id: header.indexOf('id'),
    cat: header.indexOf('cat'),
    q: header.indexOf('q'),
    a: header.indexOf('a')
  };
  const out = [];
  for(let i=1;i<lines.length;i++){
    const row = simpleCsvParse(lines[i]);
    const q = idx.q>=0 ? row[idx.q] : undefined;
    const a = idx.a>=0 ? row[idx.a] : undefined;
    if(!q || !a) continue;
    const cat = idx.cat>=0 ? row[idx.cat] : 'Okategoriserad';
    const id = idx.id>=0 && row[idx.id] ? row[idx.id] : undefined;
    out.push({id, cat, q, a});
  }
  return out;
}

function tryParseJSON(text){
  try{
    const obj = JSON.parse(text);
    if(Array.isArray(obj)) return obj;
    if(Array.isArray(obj.cards)) return obj.cards;
    return [];
  } catch(e){ return null; }
}

function normalizeCards(rawCards, sourceLabel){
  const normalized = [];
  for(let i=0;i<rawCards.length;i++){
    const r = rawCards[i] || {};
    if(!r.q || !r.a) continue;
    const idBase = r.id || `${sourceLabel||'src'}-${i+1}-${(String(r.q)+':'+String(r.a)).slice(0,24)}`;
    normalized.push({
      id: String(idBase),
      cat: r.cat ? String(r.cat) : 'Okategoriserad',
      q: String(r.q),
      a: String(r.a)
    });
  }
  return normalized;
}

function addCards(cards, sourceLabel){
  const toAdd = normalizeCards(cards, sourceLabel);
  const existingIds = new Set(allCards.map(c=>c.id));
  const deduped = toAdd.map(c=>{
    let id = c.id; let n=2;
    while(existingIds.has(id)){ id = `${c.id}#${n++}`; }
    existingIds.add(id);
    return {...c, id};
  });
  allCards = allCards.concat(deduped);
  applyFilter();
  rebuildCategoryOptions();
  render();
}

async function loadFromURL(url){
  if(!url) return alert('Ange en URL.');
  try{
    const res = await fetch(url);
    if(!res.ok) throw new Error(`${res.status} ${res.statusText}`);
    const ct = res.headers.get('content-type')||'';
    const text = await res.text();
    let parsed = null;
    if(ct.includes('json') || url.toLowerCase().endsWith('.json')){
      parsed = tryParseJSON(text);
      if(parsed===null) throw new Error('Kunde inte tolka JSON');
    } else {
      parsed = parseCSV(text);
    }
    addCards(parsed, url);
  } catch(e){
    alert('Misslyckades att ladda URL: '+ e.message);
  }
}

function loadFromFiles(fileList){
  const files = Array.from(fileList||[]);
  if(files.length===0) return;
  files.forEach(file=>{
    const reader = new FileReader();
    reader.onload = ()=>{
      const text = String(reader.result||'');
      let parsed = tryParseJSON(text);
      if(parsed===null){ parsed = parseCSV(text); }
      addCards(parsed, file.name);
    };
    reader.onerror = ()=> alert('Kunde inte läsa filen: '+file.name);
    reader.readAsText(file);
  });
}

function applyFilter(){
  const f = state.filter;
  state.deck = allCards.filter(c => f==='ALLA' ? true : c.cat===f);
  if(state.index >= state.deck.length) state.index = 0;
}

function render(){
  const total = state.deck.length;
  const done = Object.keys(state.stats.correct||{}).length;
  els.statsLine.textContent = `${total} kort • ${done} klara • Streak ${state.streak}`;

  if(total===0){
    els.cardContent.textContent = 'Inga kort laddade. Lägg till via Fil eller URL.';
    els.hint.textContent = 'Format: JSON [{q,a,cat?}] eller CSV (id,cat,q,a)';
    els.bar.style.width = '0%';
    els.footer.textContent = '';
    return;
  }
  const card = state.deck[state.index];
  els.cardContent.textContent = state.showAnswer ? card.a : card.q;
  els.cardContent.className = state.showAnswer ? 'a' : 'q';
  els.hint.textContent = state.showAnswer ? 'Svar (tryck för att dölja)' : 'Tryck för att vända';

  const pct = Math.min(100, Math.round(((state.index+1)/total)*100));
  els.bar.style.width = pct + '%';
  els.footer.textContent = `Kort ${state.index+1}/${total} • ${card.cat}`;
}

function next(){ state.index = (state.index + 1) % state.deck.length; state.showAnswer=false; render(); }
function prev(){ state.index = (state.index - 1 + state.deck.length) % state.deck.length; state.showAnswer=false; render(); }
function flip(){ state.showAnswer = !state.showAnswer; render(); }
function mark(good){
  const id = state.deck[state.index].id;
  if(good){ state.stats.correct[id] = (state.stats.correct[id]||0)+1; state.streak++; }
  else { state.stats.wrong[id] = (state.stats.wrong[id]||0)+1; state.streak = 0; }
  persist();
  next();
}
function shuffle(){
  const a = state.deck;
  for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; }
  state.index=0; state.showAnswer=false; render();
}
function reset(){
  if(confirm('Återställa framsteg?')){
    state.stats = {correct:{}, wrong:{}}; persist(); state.streak=0; render();
  }
}

/* --- Init --- */
rebuildCategoryOptions();

/* --- Event bindings (tap-first) --- */
els.btnNext.addEventListener('click', next);
els.btnPrev.addEventListener('click', prev);
els.btnFlip.addEventListener('click', flip);
els.btnGood.addEventListener('click', ()=>mark(true));
els.btnBad.addEventListener('click', ()=>mark(false));
els.btnShuffle.addEventListener('click', shuffle);
els.btnReset.addEventListener('click', reset);
els.btnHelp.addEventListener('click', ()=>{
  alert('Tips:\n• Tryck på kortet för att vända.\n• Blanda för slumpad ordning.\n• Framsteg sparas lokalt om möjligt.\n• Fullskärm fungerar bäst i mobilens webbläsare.');
});
els.btnFull.addEventListener('click', ()=>{
  const el = document.documentElement;
  const r = el.requestFullscreen || el.webkitRequestFullscreen || el.msRequestFullscreen;
  if(r) r.call(el);
});
els.category.addEventListener('change', (e)=>{ state.filter = e.target.value; state.index=0; state.showAnswer=false; applyFilter(); render(); });
els.fileInput.addEventListener('change', (e)=> loadFromFiles(e.target.files));
els.btnLoadUrl.addEventListener('click', ()=> loadFromURL(els.urlInput.value.trim()));
els.btnLoadSample.addEventListener('click', ()=> addCards(SAMPLE_CARDS, 'exempel'));
els.btnClear.addEventListener('click', ()=>{
  if(confirm('Tömma alla laddade kort?')){
    allCards = [];
    state.index = 0; state.showAnswer=false; state.streak=0;
    applyFilter(); rebuildCategoryOptions(); render();
  }
});

// Tap on card to flip
els.card.addEventListener('click', flip);

// Keyboard (optional; ignored on mobile)
window.addEventListener('keydown', (e)=>{
  if(e.key===' '){ e.preventDefault(); flip(); }
  else if(e.key==='ArrowRight'){ next(); }
  else if(e.key==='ArrowLeft'){ prev(); }
  else if(e.key==='1'){ mark(true); }
  else if(e.key==='2'){ mark(false); }
});

// Start
applyFilter();
render();
</script>
</body>
</html>
